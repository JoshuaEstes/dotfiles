#!/usr/bin/env bash
# vi: set ft=sh :
set -e
source $DOTFILES_ROOT/lib/bash/functions.sh

####
#
# First figure out what box it is and run the main dependency managers
#
if [ $(uname) == "Linux" ]; then
    if [ $(command -v apt-get) ]; then
        log_info '>> sudo apt-get update'
        sudo apt-get update
        log_info '>> sudo apt-get upgrade'
        sudo apt-get upgrade
    fi
else
    if [ $(command -v brew) ]; then
        say_this "Updating brew and installed brew packages" &
        log_info '>> brew update'
        brew update
        log_debug 'Done'
        log_info '>> brew upgrade --all'
        brew upgrade --all
        log_debug 'Done'
        log_info '>> brew linkapps'
        brew linkapps
        log_debug 'Done'
        log_info '>> brew cleanup'
        brew cleanup
        log_debug 'Done'
        log_info '>> brew prune'
        brew prune
        log_debug 'Done'
    fi
fi

###
#
# Python Stuff
#
if [ $(command -v pip) ]; then
    say_this "Running pip commands" &
    log_info '>> pip install --upgrade pip'
    pip install --upgrade pip
    log_debug 'Done'
    log_info '>> pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs pip install -U'
    pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs pip install -U
    log_debug 'Done'
fi

####
#
# Vim
#
if [ $(command -v vim) ]; then
    say_this "Upgrading vim plugins" &
    log_info '>> vim +PluginUpdate +qall'
    vim +PluginUpdate +qall
    log_debug 'Done'
fi
#### end vim ####

####
#
# PHP
#
# composer
if [ $(command -v composer) ]; then
    say_this "Updating composer and global composer dependencies" &
    log_info '>> composer selfupdate'
    composer selfupdate
    log_debug 'Done'
    log_info '>> composer global update'
    composer global update
    log_debug 'Done'
fi

# phpbrew
if [ $(command -v phpbrew) ]; then
    say_this "PHP Brew is self updating" &
    log_info '>> phpbrew self-update'
    phpbrew self-update
    log_debug 'Done'
fi

# symfony installer
if [ $(command -v symfony) ]; then
    say_this "Updating symfony installer" &
    log_info '>> symfony self-update'
    symfony self-update
    log_debug 'Done'
fi

# Magento
if [ $(command -v n98-magerun.phar) ]; then
    say_this "Updating Mage run for magento" &
    log_info '>> n98-magerun.phar self-update'
    n98-magerun.phar self-update
    log_debug 'Done'
fi
#### end php ####

####
#
# Ruby
#
if [ $(command -v gem) ]; then
    say_this "Updating ruby gems" &
    log_info '>> gem update --system'
    gem update --system
    log_debug 'Done'
    log_info '>> gem update'
    gem update
    log_debug 'Done'
    log_info '>> gem cleanup'
    gem cleanup
    log_debug 'Done'
fi
#### end ruby ####

####
#
# Node
#
if [ $(command -v npm) ]; then
    say_this "Updating NPM and NPM dependencies" &
    log_info '>> npm install -g npm@latest'
    npm install -g npm@latest
    log_debug 'Done'
    log_info '>> npm update -g'
    npm update -g
    log_debug 'Done'
fi
#### end node ####

####
#
# Heroku
#
if [ $(command -v heroku) ]; then
    say_this "Updating heroku toolbelt" &
    log_info '>> heroku update'
    heroku update
    log_debug 'Done'
fi
#### end heroku ####

say_this "Updates complete" &
exit 0
